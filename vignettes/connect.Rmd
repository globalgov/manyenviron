---
title: "How Do Environmental Treaties Connect?"
authors: "James Hollway, Esther Peev, and Henrique Sposito"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How Do Environmental Treaties Connect?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## qEnviron Data

 `{qEnviron}` stores several datasets on various aspects of environmental treaties in different databases. For example, the **Agreements** database is made of multiple datasets of environmental treaty titles with specific information such as the agreement type (e.g. agreements, protocols, amendments, declarations), if they are bilateral or multilateral, and some important dates such as the signature or entry into force. The **Memberships** database contains lists of countries with the treaties to which they are parties to. It also includes information on the signature date of the treaty or the withdrawal date of a party. The **References** database is composed of a dataset that indicates the relationship (e.g. amended by, cites, superseded by) between two treaties. Finally, the **Texts** database stores the text of environmental treaties.

## Connecting Environmental Treaties

There are many different ways in which treaties could be linked. For example, a treaty can be substituted by another, complemented by protocols, changed through amendments, and/or cite another treaty. To facilitate the identification and connection between the databases in the package, the `qCreate::code_agreements()` function has been developed to generate a qID for treaties in a database. Each of the `{qEnviron}` dataset contains a qID column. To understand what are the information provided through by the qID, as well as the benefits of using qID to spot the relationships between the treaties across several datasets in a database, please visit this [article](https://globalgov.github.io/qCreate/articles/agreements.html) on the `{qCreate}` website.

Below are two examples of how to visualise treaty linkages for the references and the memberships databases in `{qEnviron}`. We use `{migraph}` to create the network plots, more information about the package can be found [here](https://snlab-ch.github.io/migraph/).

### Visualising How Agreements Connect by References

The graph below illustrates a sample of earliest 25 treaties from the references database. We select only treaties that cite other treaties. The qIDs are used to facilitate the reading and illustration of the relationships.

```{r references, warning=FALSE, message=FALSE}
library(dplyr)
library(migraph)
references <- qEnviron::references$ECOLEX_REF %>% 
  dplyr::distinct() %>%
  dplyr::mutate(year = stringr::str_extract(qID2, "[:digit:]{4}")) %>%
  dplyr::filter(RefType == "Cites") %>%
  dplyr::arrange(year)
migraph::gglineage(references[1:25,c(1,2,3)])
```

### Visualising How Agreements Connect by Membership

The graph below illustrates the connection between parties and treaties in two points in time, 1960 and 1980, using the memberships database. In the graph, countries are represented by the squares, the treaties by the dots, and memberships by the edges. qIDs are also used to refer to treaty titles. 

```{r memberships, warning=FALSE, message=FALSE}
library(ggplot2)
membership_1960 <- qEnviron::memberships$IEADB_MEM %>%
  dplyr::mutate(year = stringr::str_extract(qID_ref, "[:digit:]{4}")) %>%
  dplyr::filter(year == "1960") %>%
  dplyr::select(qID, CountryID, Title) %>%
  migraph::as_tidygraph()
migraph::autographr(membership_1960) + ggplot2::ggtitle("Membership in Environmental Treaties in 1960")
membership_1980 <- qEnviron::memberships$IEADB_MEM %>%
  dplyr::mutate(year = stringr::str_extract(qID_ref, "[:digit:]{4}")) %>%
  dplyr::filter(year == "1980") %>%
  dplyr::select(qID, CountryID, Title) %>%
  migraph::as_tidygraph()
migraph::autographr(membership_1980) + ggplot2::ggtitle("Membership in Environmental Treaties in 1980")
```
